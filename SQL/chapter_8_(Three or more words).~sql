------------------------------------------------------------------------------------------------------------------------------------------
                           -------------------------Глава 8. Не более двух слов.-----------------------
                           -------------------------------------------------"Ты поэт или кто?"---------
------------------------------------------------------------------------------------------------------------------------------------------
CREATE TABLE a_list 
(id_ NUMBER(4) PRIMARY KEY,
author VARCHAR2(50 CHAR),
text VARCHAR2(3000 CHAR));

TRUNCATE TABLE a_list;
INSERT INTO a_list VALUES(1, 'Александр Сергеевич Пушкин',
'Не мысля гордый свет забавить,
Вниманье дружбы возлюбя,
Хотел бы я тебе представить
Залог достойнее тебя,
Достойнее души прекрасной,
Святой исполненной мечты,
Поэзии живой и ясной,
Высоких дум и простоты.
Но так и быть — рукой пристрастной
Прими собранье пестрых глав,
Полусмешных, полупечальных,
Простонародных, идеальных,
Небрежный плод моих забав,
Бессонниц, легких вдохновений,
Незрелых и увядших лет,
Ума холодных наблюдений
И сердца горестных замет.');
INSERT INTO a_list VALUES(2, 'Алексей Николаевич Савеленко', 'слово слово?неслово слово слово!');
INSERT INTO a_list VALUES(3, 'Лев Николаевич Толстой',
'«Али давно не таскалъ!» – сказалъ мужикъ съ обмерзлыми сосульками на бороде и усахъ, входя вечеромъ въ избу и обращаясь къ бабе.
Онъ только что поскользнулся въ сеняхъ и едва удержался о притолку. – «Опять налили сенцы, идолы!» – «А ты ушатъ починилъ, чтоли?» – сказала баба. – «Ноне бабы 5 разъ за водой ходили,
что принесутъ, половина вытечетъ». – «Начинишься на васъ, чертей.
Космы повыдергаю, такъ не потечетъ». – Мужикъ прiехалъ изъ лесу не въ духе: караульщикъ засталъ его накладывающимъ молодые дубочки, которыя онъ срубилъ въ господскомъ лесе, и содралъ съ него на косушку.
Кроме того онъ поскользнулся. Баба видела, что дело плохо, и лучше молчать.');
INSERT INTO a_list VALUES(4, 'noname', 'Простое предложение. Предложение чуть по-сложнее. И очень сложное предложение.');
INSERT INTO a_list VALUES(5, 'TEST1', 'один? два два? три три три! два два? один;');
INSERT INTO a_list VALUES(6, 'TEST2', 'один? два два? вчера "три" сегодня (три) завтра:три! два два? один;');
INSERT INTO a_list VALUES(7, 'TEST3',
'Two roads diverged in a yellow wood,
And sorry I could not travel both
And be one traveler, long I stood
And looked down one as far as  could
To where it bent in the undergrowth.');
INSERT INTO a_list VALUES(8, 'АНДРЕЙ',
'In big city 
Was a bad boy
And one man fighted with this boy
And he said to boy
"You are bad boy"');

-------------------------MAIN SELECT
SELECT * FROM a_list
WHERE regexp_like(lower(text), '(^|[ ":/(/)[:space:]])([[:lower:]]+)([ ":/(/)[:space:]]+[^;!?/.]+)?[ ":/(/)[:space:]]+(\2)([ ":/(/)[:space:]]+[^;!?/.]+)?[ ":/(/)[:space:]]+(\2)([ ":/(/)[:space:]]+[^;!?/.]+)?[;!?/.]');
-----------
SELECT a.*
FROM (SELECT aa.*, 
regexp_instr(lower(text), '(^|[ ":/(/)[:space:]])([[:lower:]]+)([ ":/(/)[:space:]]+[^;!?/.]+)?[ ":/(/)[:space:]]+(\2)([ ":/(/)[:space:]]+[^;!?/.]+)?[ ":/(/)[:space:]]+(\2)([ ":/(/)[:space:]]+[^;!?/.]+)?[;!?/.]') pos_ 
FROM a_list aa) a;

--'(^|[ ":/(/)])([[:lower:]]+)([ ":/(/)]+[^;!?/.]+)?[ ":/(/)]+(\2)([ ":/(/)]+[^;!?/.]+)?[ ":/(/)]+(\2)([ ":/(/)]+[^;!?/.]+)?[;!?/.]'
--1
select str, regexp_replace(t.str, '[[:cntrl:]]') as new_str
from (
      select 'test1'||chr(28) as str from dual
      union all
      select 'test2' from dual
      union all
      select 'test3+_*- =\\\|()^%#3@' from dual
      ) t
where regexp_like(t.str, '[[:cntrl:]]')

--2
--Для того чтобы разбить строку на подстроки, используя разделитель «;», можно воспользоваться следующим запросом.
SELECT regexp_substr(str, '[^;]+', 1, level) str
FROM (SELECT ' 1; 2; test1.; nope' str FROM dual) t
CONNECT BY instr(str, ';', 1, level - 1) > 0;

--3
--Если хотим разбить на слова используя в виде разделителя пробел, то можно использовать perl синтаксис
SELECT regexp_substr(str, '\S+', 1, level) str
FROM (SELECT ' 1 alex nope 2 test1.' str FROM dual) t
connect by regexp_substr(str,'\S+',1,level) is not NULL;

--4
--Если требуется разделить не только на строки, но и на столбцы
select
     regexp_substr(str, '[^=]+', 1, 1) as str1,
     regexp_substr(str, '[^=]+', 1, 2) as str2,
     regexp_substr(str, '[^=]+', 1, 3) as str3,
     regexp_substr(str, '[^=]+', 1, 4) as str4
from (
      select regexp_substr(str, '[^@]+', 1, level) str
      from (
            select rtrim('field1=field2=field3=field3_2@field3=field4@field5=field6=field7@','@') str
            from dual)
      CONNECT BY REGEXP_INSTR (str, '@', 1, level - 1) > 0
      );
 
--5
--

with t as
(
select 'a+b-c+d' str from dual
)
select case 
       when level != 1
         then regexp_substr(str, '[*+|-]', 1, level-1)
       end prefix_sign,
       regexp_substr(str, '[^+|-]+', 1, level) str,
       regexp_substr(str, '[*+|-]', 1, level) postfix_sign
from t
CONNECT BY regexp_substr(str, '[^+|-]+', 1, level) is not null;







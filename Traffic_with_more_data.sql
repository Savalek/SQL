--id=11
INSERT INTO tariff
VALUES(11,to_date('10.10.2013','DD.MM.YYYY'),700);
INSERT INTO tariff
VALUES(11,to_date('10.11.2013','DD.MM.YYYY'),900);
INSERT INTO tariff
VALUES(11,to_date('18.02.2014','DD.MM.YYYY'),1000);
INSERT INTO tariff
VALUES(11,to_date('24.12.2014','DD.MM.YYYY'),9000);
INSERT INTO tariff
VALUES(11,to_date('15.10.2015','DD.MM.YYYY'),100);
INSERT INTO tariff
VALUES(11,to_date('29.10.2015','DD.MM.YYYY'),200);
INSERT INTO tariff
VALUES(11,to_date('08.11.2015','DD.MM.YYYY'),300);
INSERT INTO tariff
VALUES(11,to_date('30.09.2016','DD.MM.YYYY'),500);

INSERT INTO traffic
VALUES(11,to_date('02.01.2013','DD.MM.YYYY'),878787887);
INSERT INTO traffic
VALUES(11,to_date('17.04.2013','DD.MM.YYYY'),-87);
INSERT INTO traffic
VALUES(11,to_date('02.07.2013','DD.MM.YYYY'),707);
INSERT INTO traffic
VALUES(11,to_date('03.07.2013','DD.MM.YYYY'),-200);
--id=12
INSERT INTO tariff
VALUES(12,to_date('10.10.2010','DD.MM.YYYY'),100);
INSERT INTO tariff
VALUES(12,to_date('28.04.2011','DD.MM.YYYY'),200);
INSERT INTO tariff
VALUES(12,to_date('12.07.2011','DD.MM.YYYY'),300);
INSERT INTO tariff
VALUES(12,to_date('09.09.2012','DD.MM.YYYY'),400);
INSERT INTO tariff
VALUES(12,to_date('28.03.2013','DD.MM.YYYY'),500);
INSERT INTO tariff
VALUES(12,to_date('03.12.2013','DD.MM.YYYY'),600);

INSERT INTO traffic
VALUES(12,to_date('18.04.2010','DD.MM.YYYY'),100);
INSERT INTO traffic
VALUES(12,to_date('07.06.2010','DD.MM.YYYY'),200);
INSERT INTO traffic
VALUES(12,to_date('02.07.2010','DD.MM.YYYY'),50);
INSERT INTO traffic
VALUES(12,to_date('21.08.2010','DD.MM.YYYY'),-50);
INSERT INTO traffic
VALUES(12,to_date('04.11.2010','DD.MM.YYYY'),10);
INSERT INTO traffic
VALUES(12,to_date('18.01.2011','DD.MM.YYYY'),10);
INSERT INTO traffic
VALUES(12,to_date('03.04.2011','DD.MM.YYYY'),10);
INSERT INTO traffic
VALUES(12,to_date('23.05.2011','DD.MM.YYYY'),100);
INSERT INTO traffic
VALUES(12,to_date('20.10.2011','DD.MM.YYYY'),30);
INSERT INTO traffic
VALUES(12,to_date('07.05.2012','DD.MM.YYYY'),10);
INSERT INTO traffic
VALUES(12,to_date('21.07.2012','DD.MM.YYYY'),10);
INSERT INTO traffic
VALUES(12,to_date('29.10.2012','DD.MM.YYYY'),10);
INSERT INTO traffic
VALUES(12,to_date('28.03.2013','DD.MM.YYYY'),10);
INSERT INTO traffic
VALUES(12,to_date('06.07.2013','DD.MM.YYYY'),10);
INSERT INTO traffic
VALUES(12,to_date('19.09.2013','DD.MM.YYYY'),10);
--id=13
INSERT INTO tariff
VALUES(13,to_date('12.12.2010','DD.MM.YYYY'),100);

INSERT INTO traffic
VALUES(13,to_date('24.12.2010','DD.MM.YYYY'),150);
INSERT INTO traffic
VALUES(13,to_date('12.11.2010','DD.MM.YYYY'),150);

--id=14
INSERT INTO tariff
VALUES(14,to_date('12.12.2010','DD.MM.YYYY'),100);

INSERT INTO traffic
VALUES(14,to_date('12.11.2010','DD.MM.YYYY'),150);


--id=15
INSERT INTO tariff
VALUES(15,to_date('12.12.2012','DD.MM.YYYY'),1000);

INSERT INTO traffic
VALUES(15,to_date('12.12.2012','DD.MM.YYYY'),500);
INSERT INTO traffic
VALUES(15,to_date('12.12.2013','DD.MM.YYYY'),-500);
INSERT INTO traffic
VALUES(15,to_date('31.01.2014','DD.MM.YYYY'),1005);

--id=16
INSERT INTO tariff
VALUES(16,to_date('13.03.2013','DD.MM.YYYY'),200);
INSERT INTO tariff
VALUES(16,to_date('30.08.2013','DD.MM.YYYY'),100);
INSERT INTO tariff
VALUES(16,to_date('29.09.2013','DD.MM.YYYY'),250);

INSERT INTO traffic
VALUES(16,to_date('20.05.2013','DD.MM.YYYY'),-70);
INSERT INTO traffic
VALUES(16,to_date('31.07.2013','DD.MM.YYYY'),170);
INSERT INTO traffic
VALUES(16,to_date('08.12.2013','DD.MM.YYYY'),30);

--id=17
INSERT INTO tariff
VALUES(17,to_date('10.05.2011','DD.MM.YYYY'),20);
INSERT INTO tariff
VALUES(17,to_date('17.10.2011','DD.MM.YYYY'),1000);

INSERT INTO traffic
VALUES(17,to_date('29.06.2011','DD.MM.YYYY'),-1000);
INSERT INTO traffic
VALUES(17,to_date('18.08.2011','DD.MM.YYYY'),500);
INSERT INTO traffic
VALUES(17,to_date('07.10.2011','DD.MM.YYYY'),500);

--id=19
INSERT INTO tariff
VALUES(19,to_date('10.04.2011','DD.MM.YYYY'),20);
INSERT INTO tariff
VALUES(19,to_date('17.11.2011','DD.MM.YYYY'),1000);

INSERT INTO traffic
VALUES(19,to_date('15.06.2011','DD.MM.YYYY'),-1000);
INSERT INTO traffic
VALUES(19,to_date('18.08.2011','DD.MM.YYYY'),500);
INSERT INTO traffic
VALUES(19,to_date('20.10.2011','DD.MM.YYYY'),-700);



--id=20
INSERT INTO tariff
VALUES(20,to_date('10.05.2011','DD.MM.YYYY'),800);
INSERT INTO tariff
VALUES(20,to_date('17.10.2011','DD.MM.YYYY'),200);

--id=21
INSERT INTO traffic
VALUES(21,to_date('12.03.2011','DD.MM.YYYY'),250);
INSERT INTO traffic
VALUES(21,to_date('21.07.2011','DD.MM.YYYY'),400);


--id=18
INSERT INTO tariff
VALUES(18,to_date('5.05.2015','DD.MM.YYYY'),700);
INSERT INTO tariff
VALUES(18,to_date('20.05.2015','DD.MM.YYYY'),2000);

INSERT INTO traffic
VALUES(18,to_date('28.01.2015','DD.MM.YYYY'),-1000);
INSERT INTO traffic
VALUES(18,to_date('18.02.2015','DD.MM.YYYY'),400);
INSERT INTO traffic
VALUES(18,to_date('20.02.2015','DD.MM.YYYY'),400);
INSERT INTO traffic
VALUES(18,to_date('15.05.2015','DD.MM.YYYY'),-1000);


--id=22
INSERT INTO tariff
VALUES(22,to_date('12.07.2015','DD.MM.YYYY'),1200);

INSERT INTO traffic
VALUES(22,to_date('20.04.2015','DD.MM.YYYY'),-1000);
INSERT INTO traffic
VALUES(22,to_date('15.07.2015','DD.MM.YYYY'),1000);
INSERT INTO traffic
VALUES(22,to_date('20.07.2015','DD.MM.YYYY'),1000);
INSERT INTO traffic
VALUES(22,to_date('20.08.2015','DD.MM.YYYY'),-1000);


--id=23
INSERT INTO tariff
VALUES (23 , to_date('20.05.2014','DD.MM.YYYY'), 1000);
INSERT INTO tariff
VALUES (23 , to_date('20.07.2014','DD.MM.YYYY'), 2500);


INSERT INTO traffic
VALUES(23,to_date('20.06.2014','DD.MM.YYYY'),600);
INSERT INTO traffic
VALUES(23,to_date('25.06.2014','DD.MM.YYYY'),400);
INSERT INTO traffic
VALUES(23,to_date('25.07.2014','DD.MM.YYYY'),500);

--id=24
INSERT INTO tariff
VALUES (24 , to_date('20.05.2014','DD.MM.YYYY'), 600);


INSERT INTO traffic
VALUES(24,to_date('07.03.2014','DD.MM.YYYY'),1500);
INSERT INTO traffic
VALUES(24,to_date('25.03.2014','DD.MM.YYYY'),-1000);


--13,14,15,16,17,18,19,22
select to_date('10.05.2011','DD.MM.YYYY')-to_date('07.10.2011','DD.MM.YYYY')from dual






-- для view:     
CREATE OR REPLACE VIEW list_ AS
SELECT row_number() OVER(PARTITION BY id_user ORDER BY dat) num_, t.*
FROM (
      SELECT id_user, 'Тариф' type_, lim count_, tar_dat dat
      FROM Tariff
      UNION
      SELECT id_user, 'Трафик' type_, count_, dat
      FROM (
           SELECT id_user, sum(amt) count_, trunc(dat) dat
           FROM Traffic
           GROUP BY id_user, trunc(dat)
           ) tt
      UNION
      SELECT id_user, 'Тариф' type_, (99999999999) count_, to_date('01/01/1000', 'dd/mm/yyyy') dat -- 99..99 -непреодолимый лимит; 1000 год меньший любого возможного
      FROM (SELECT id_user FROM traffic) tt
     ) t;
------Вывод юзеров:
WITH t_list AS
(SELECT id_user, count_, dat
FROM list_ l WHERE type_ = 'Тариф'
ORDER BY id_user, dat DESC)
SELECT * FROM (
SELECT num_, id_user, type_, count_, dat, sum_before_100, limit_before_100, CASE WHEN sum_before_100 <= limit_before_100 THEN '+' ELSE 'CAUGTH' END AS check1,
       sum_after_100, limit_after_100, CASE WHEN sum_after_100 <= limit_after_100 THEN '+' ELSE 'CAUGTH' END AS check2
FROM( SELECT l.*,
           SUM(CASE type_ WHEN 'Трафик' THEN count_ ELSE 0 END) 
           OVER(PARTITION BY id_user ORDER BY dat  RANGE 100 PRECEDING) sum_before_100,
           (SELECT count_ FROM t_list t WHERE t.id_user = l.id_user AND t.dat <= l.dat AND ROWNUM = 1) limit_before_100,
           COALESCE(SUM(CASE type_ WHEN 'Трафик' THEN count_ ELSE 0 END) 
           OVER(PARTITION BY id_user ORDER BY dat RANGE BETWEEN 1 FOLLOWING AND 101 FOLLOWING), 0) sum_after_100,
           (SELECT count_ FROM t_list t WHERE t.id_user = l.id_user AND t.dat <= l.dat + 100 AND ROWNUM = 1) limit_after_100
     FROM list_ l) temp
     ) temp2
WHERE check1 = 'CAUGTH' OR check2 = 'CAUGTH'
ORDER BY id_user, num_; 
